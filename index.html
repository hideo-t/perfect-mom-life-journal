<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>完璧ママの日々奮闘記</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a2e;
      --text-primary: #e0ddd5;
      --text-secondary: #8a8a9a;
      --accent: #4a9eff;
      --accent-dim: #2a5a9a;
      --gold: #c4a35a;
      --chapter-border: #2a2a3e;
      --serif: 'Noto Serif JP', 'Hiragino Mincho ProN', serif;
      --sans: 'Zen Kaku Gothic New', 'Hiragino Kaku Gothic ProN', sans-serif;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--serif);
      font-size: 17px;
      line-height: 1.95;
      min-height: 100vh;
    }

    /* ─── Header ─── */
    .hero {
      position: relative;
      text-align: center;
      padding: 100px 20px 80px;
      background: linear-gradient(180deg, #1a2a4a 0%, #0f1a2f 100%);
      overflow: hidden;
    }
    .hero::before {
      content: '';
      position: absolute; inset: 0;
      background: radial-gradient(ellipse at 50% 30%, rgba(120,180,255,0.15) 0%, transparent 70%);
    }
    .hero-title {
      font-family: var(--serif);
      font-size: clamp(1.8rem, 5vw, 3.2rem);
      font-weight: 700;
      letter-spacing: 0.08em;
      color: #ffffff;
      text-shadow: 0 2px 20px rgba(100,160,255,0.3);
      margin-bottom: 12px;
      position: relative;
    }
    .hero-sub {
      font-family: var(--sans);
      font-size: 0.9rem;
      color: #b0c4de;
      letter-spacing: 0.15em;
    }
    .hero-line {
      width: 60px; height: 1px;
      background: var(--gold);
      margin: 28px auto 0;
    }

    /* ─── Navigation ─── */
    .nav-bar {
      position: sticky; top: 0; z-index: 100;
      background: rgba(10,10,15,0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--chapter-border);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      overflow-x: auto;
      font-family: var(--sans);
      font-size: 0.8rem;
    }
    .nav-bar .nav-title {
      color: var(--gold);
      font-weight: 700;
      white-space: nowrap;
      margin-right: 8px;
    }
    .nav-bar a {
      color: var(--text-secondary);
      text-decoration: none;
      white-space: nowrap;
      padding: 4px 10px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .nav-bar a:hover {
      color: var(--accent);
      background: rgba(74,158,255,0.1);
    }

    /* ─── TOC ─── */
    .toc {
      max-width: 700px;
      margin: 60px auto 40px;
      padding: 0 20px;
    }
    .toc h3 {
      font-family: var(--sans);
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 20px;
    }
    .toc-item {
      display: flex; align-items: center; gap: 16px;
      padding: 14px 18px;
      color: var(--text-primary);
      text-decoration: none;
      border-left: 2px solid var(--chapter-border);
      transition: all 0.25s;
      font-family: var(--sans);
      font-size: 0.95rem;
    }
    .toc-item:hover {
      border-color: var(--accent);
      background: rgba(74,158,255,0.04);
      padding-left: 24px;
    }
    .toc-num {
      font-size: 0.75rem;
      color: var(--accent-dim);
      font-weight: 700;
      min-width: 20px;
    }

    /* ─── Characters ─── */
    .characters {
      max-width: 700px;
      margin: 40px auto 60px;
      padding: 0 20px;
    }
    .characters h3 {
      font-family: var(--sans);
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }
    .char-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
    }
    .char-card {
      background: var(--bg-card);
      border: 1px solid var(--chapter-border);
      border-radius: 8px;
      padding: 18px;
    }
    .char-name {
      font-family: var(--sans);
      font-weight: 700;
      font-size: 1rem;
      color: var(--gold);
      margin-bottom: 4px;
    }
    .char-role {
      font-family: var(--sans);
      font-size: 0.75rem;
      color: var(--accent);
      margin-bottom: 8px;
    }
    .char-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* ─── Divider ─── */
    .section-divider {
      width: 40px; height: 1px;
      background: var(--chapter-border);
      margin: 0 auto;
    }

    /* ─── Chapter ─── */
    .chapter {
      max-width: 700px;
      margin: 0 auto;
      padding: 80px 20px;
      border-top: 1px solid var(--chapter-border);
    }
    .chapter-header {
      text-align: center;
      margin-bottom: 48px;
    }
    .chapter-number {
      font-family: var(--sans);
      font-size: 0.7rem;
      letter-spacing: 0.25em;
      color: var(--accent-dim);
      display: block;
      margin-bottom: 8px;
    }
    .chapter-title {
      font-family: var(--serif);
      font-size: clamp(1.3rem, 3vw, 1.8rem);
      font-weight: 700;
      letter-spacing: 0.05em;
    }
    .chapter-image {
      margin: 0 -20px 40px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--chapter-border);
    }
    .chapter-image img {
      width: 100%;
      height: auto;
      display: block;
      opacity: 0.92;
    }
    .chapter-body p {
      margin-bottom: 1.2em;
      text-indent: 1em;
      text-align: justify;
    }
    .chapter-body p:empty {
      display: none;
    }

    /* ─── Footer ─── */
    .footer {
      text-align: center;
      padding: 60px 20px;
      font-family: var(--sans);
      font-size: 0.75rem;
      color: var(--text-secondary);
      border-top: 1px solid var(--chapter-border);
    }

    /* ─── Reading mode toggle ─── */
    .mode-toggle {
      position: fixed; bottom: 20px; right: 20px; z-index: 200;
      background: var(--bg-card);
      border: 1px solid var(--chapter-border);
      color: var(--text-secondary);
      font-family: var(--sans);
      font-size: 0.75rem;
      padding: 8px 14px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mode-toggle:hover {
      border-color: var(--accent);
      color: var(--accent);
    }


    /* --- TTS Read Aloud --- */
    .tts-fab {
      position: fixed; bottom: 80px; right: 20px; z-index: 200;
      width: 48px; height: 48px; border-radius: 50%;
      background: var(--accent); color: #fff; border: none;
      font-size: 22px; cursor: pointer;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      transition: all 0.3s;
      display: flex; align-items: center; justify-content: center;
    }
    .tts-fab:hover { transform: scale(1.1); }
    .tts-fab.speaking { background: #e74c3c; animation: tts-pulse 1.5s infinite; }
    @keyframes tts-pulse {
      0%,100% { box-shadow: 0 4px 16px rgba(231,76,60,0.4); }
      50% { box-shadow: 0 4px 24px rgba(231,76,60,0.7); }
    }
    .tts-bar {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
      background: rgba(20,20,30,0.95); backdrop-filter: blur(12px);
      border-top: 1px solid var(--chapter-border);
      padding: 10px 16px; display: none;
      align-items: center; gap: 10px;
      font-family: var(--sans); font-size: 0.85rem;
    }
    .tts-bar.active { display: flex; flex-wrap: wrap; }
    .tts-bar button {
      background: none; border: 1px solid var(--text-secondary);
      color: var(--text-primary); border-radius: 6px;
      padding: 6px 12px; cursor: pointer; font-size: 0.8rem;
      white-space: nowrap; transition: all 0.2s;
    }
    .tts-bar button:hover { border-color: var(--accent); color: var(--accent); }
    .tts-bar .tts-info {
      flex: 1; color: var(--text-secondary);
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      min-width: 80px;
    }
    .tts-bar .tts-speed {
      display: flex; align-items: center; gap: 4px;
      color: var(--text-secondary); font-size: 0.75rem;
    }
    .tts-bar .tts-speed input { width: 60px; accent-color: var(--accent); }
    body.light .tts-bar {
      background: rgba(245,245,240,0.95); border-top-color: #ddd;
    }
    body.light .tts-bar button { border-color: #999; color: #333; }
    body.light .tts-bar .tts-info { color: #666; }

    /* ─── Light mode ─── */
    body.light {
      --bg-primary: #f5f0e8;
      --bg-secondary: #ebe5d9;
      --bg-card: #fff;
      --text-primary: #2a2a2a;
      --text-secondary: #6a6a6a;
      --chapter-border: #d5cfc3;
      --accent: #2563eb;
      --accent-dim: #6b9eff;
      --gold: #8a6d2b;
    }

    /* ─── Responsive ─── */
    @media (max-width: 600px) {
      body { font-size: 15px; }
      .chapter { padding: 50px 16px; }
    }

    /* ─── Scroll progress ─── */
    .scroll-progress {
      position: fixed; top: 0; left: 0; z-index: 200;
      height: 2px;
      background: linear-gradient(90deg, var(--accent), var(--gold));
      width: 0%;
      transition: width 0.1s;
    }
  </style>
</head>
<body>
  <div class="scroll-progress" id="progress"></div>

  <header class="hero">
    <h1 class="hero-title">完璧ママの日々奮闘記</h1>
    <p class="hero-sub">GENERATED WITH LOCAL AI — OLLAMA + STABLE DIFFUSION</p>
    <div class="hero-line"></div>
  </header>

  <nav class="nav-bar">
    <span class="nav-title">目次</span>
    <a href="#chapter-1">第1章</a><a href="#chapter-2">第2章</a><a href="#chapter-3">第3章</a>
  </nav>

  <div class="toc">
    <h3>— 目次 —</h3>
        <a href="#chapter-1" class="toc-item"><span class="toc-num">1</span><span class="toc-label">新しい始まり</span></a>
        <a href="#chapter-2" class="toc-item"><span class="toc-num">2</span><span class="toc-label">食事作りに挑戦</span></a>
        <a href="#chapter-3" class="toc-item"><span class="toc-num">3</span><span class="toc-label">家族の一日</span></a>
  </div>

  <div class="characters">
    <h3>— 登場人物 —</h3>
    <div class="char-grid">
      <div class="char-card">
        <div class="char-name">小夜子</div>
        <div class="char-role">main</div>
        <div class="char-desc">完璧主義者で献身的な性格だが、家族への愛情は深い</div>
      </div>
      <div class="char-card">
        <div class="char-name">拓也</div>
        <div class="char-role">sub</div>
        <div class="char-desc">元気いっぱい。母親への依存心が高い</div>
      </div>
    </div>
  </div>

  <div class="section-divider"></div>

  <main>

    <section class="chapter" id="chapter-1">
      <div class="chapter-header">
        <span class="chapter-number">第1章</span>
        <h2 class="chapter-title">新しい始まり</h2>
      </div>
      
      <div class="chapter-body">
        <p>朝霧が薄暗い空の下で溶けていく。新居の一室では、まだ日差しが射してこない。窓ガラスに張られた透明なフィルム越しには僅かしか明るさはなく、部屋の中は静寂と闇が支配していた。その薄暗い中に、小夜子の姿があった。</p>

        <p>手袋をした彼女の手先は、冷たいフローリングへと触れ合う音とともに動き始めた。「ボックスティッシュ」、「食器洗剤」というラベルを見るたびに、新たな生活への期待が胸の中で膨らむ。引っ越し当日から小夜子の目には、全てが新鮮で未知なる冒険だった。</p>

        <p>小さな鞄を手にとって歩み去り、彼女はリビングへと進んだ。「まだ片付いてない」という現実に直面しながらも、その場所からはすでに明日への準備が始めていた。そこでは、先日購入した家具が静かで見知らぬ形のまま置かれている。</p>

        <p>「拓也を起こす前に」と口の中でつぶやきながら、彼女は再び手袋を取り出し、カーテンを開ける動きに繋げた。「あかり」、「風通し」。シンプルな言葉だけれども、それが小夜子の生活における新たなリズムを形成していく。</p>

        <p>太陽が高くなり始めた頃には窓ガラスは完全に透き通り、朝露から晴れた空へと変わり果てていた。「これで家の中にも光が入るね」と小さな声と共に拓也が部屋に入ってくる。彼の手からはベビーカーを押す力があり、それはまだ幼さの中にこそ見つけられる自信のようなものを感じさせる。</p>

        <p>「おはよう、ママ」</p>
        <p>小夜子を見上げて微笑んだ。</p>
        <p>「今から朝ご飯を作るね」</p>

        <p>その瞬間、彼女の背後では新しい日が新たな一日の始まりと共に息をつくように静かに進行していた。そしてその光は、小さな家族が共にする日常と新たな冒険への期待へと小夜子の心を満たしていく。</p>

        <p>冷蔵庫の中身を見て、「あら、まだ何も入ってない」と彼女は少し顔を曇らせ、しかしすぐに「じゃあ今日からその状態で頑張ろう」と自分自身に言い聞かせるように笑った。それを見ていた拓也もまた、母親のそんな表情から元気を取り戻し、「ママと一緒に食べるね」そう言って彼女の手を握り締めた。</p>

        <p>朝が進むにつれて新居は少しずつ生活感を持ち始める。「窓を開けて」という小夜子の一言で風が室内に吹き込んで、その冷たさと同時に新たな息吹も運んでくる。それと共に彼女の心にも希望の種が始まった。</p>

        <p>「今日から新しいスタートだね」</p>
        <p>そう言って微笑んだ後、小夜子はまた掃除を始めた。</p>
        <p>新居での初日はまだ整理がつかない部分が多いものの、その中で彼女自身と向き合う時間も生まれていた。新たな家という空間に映し出されるのは、それぞれの瞬間からの連続性であり、日々の中で織り成す日常の温もりでもあった。</p>

        <p>その背後では朝日が昇り続け、一日を紡いでいく。「今日から新しい始まりだ」と小夜子は強く心でつぶやき、そして新たな一歩へと足を進めていった。</p>
      </div>
    </section>
    <section class="chapter" id="chapter-2">
      <div class="chapter-header">
        <span class="chapter-number">第2章</span>
        <h2 class="chapter-title">食事作りに挑戦</h2>
      </div>
      
      <div class="chapter-body">
        <p>朝の光が淡い橙色から暖かな黄色に変わり、窓ガラス越しに差し込む。外では鳥たちが囀り始めている音と、遠くで鳴るドライヤーの唸り声。新居の一室はまだ静かだ。</p>

        <p>リビングへ向けて歩みを進める足元には、先日購入した食器セットが並んでいる。小夜子はその一つを取り上げて手の中ですっと音を立てる。冷たく滑らかな感触に頬杖をついて深呼吸する。</p>

        <p>「今日は料理教室だね」と声が聞こえる。</p>
        <p>振り返るとそこには、ベビーカーから顔を覗かせている拓也の姿があった。「うん、新しい場所で友達作るよ」小夜子は笑って答えた。その言葉通り、今日からは地域コミュニティとの関係も始める。</p>

        <p>キッチンに立ち料理教室の準備をする。</p>
        <p>冷蔵庫から取り出した材料がテーブルを覆い始めた。「今日は何を作ろうかな」と独り言のようにつぶやく。</p>
        <p>卵黄と白身を別々に分けて、それらはそれぞれ独特な形を持っていた。小夜子は包丁で玉ねぎを切る音と共に考えを巡らせた。</p>

        <p>教室へ向かう路地裏には秋の訪れを感じさせる風が吹き抜ける。「すずしい」と拓也。</p>
        <p>「そうですね、紅葉も始まってるわ」</p>
        <p>歩みながら手袋越しに樹木を見つめていると、そこにはまだ緑色を残しつつ赤や黄色へ移り変わる木々があった。</p>

        <p>教室の扉を開くと暖かな空気が中から流れ出る。</p>
        <p>「おはようございます」と小夜子が声をかける。「こんにちは」クラスメートたちも笑顔で挨拶をする。互いに自己紹介をする時間がある。一人ひとりそれぞれ個性があり、共通点もある。</p>

        <p>準備の間隙を取り入れて材料や道具を揃える。</p>
        <p>「今度はパン作りね」と小夜子が言いながら取り掛かる。「あたしも手伝う！」拓也。「待ってよ〜、お母さんと一緒にやりたいんだから」その言葉と共に包丁を持つ腕に力を込める。</p>

        <p>窓からの光と音の隙間で、教室は穏やかな空気に満ちていた。</p>
        <p>「まずは下準備からね」と小夜子が指示を出す。「あたしも一緒に！」拓也。調理器具と材料との触れ合いの中で、それぞれ自分の役割を見つけ始める。</p>

        <p>焼き上がりに近づく時間と共に教室全体の香りは豊かになる。</p>
        <p>「もうすぐ出来てるんだよ〜」と小夜子が言った時、「ほんとに？」と拓也。「うん、楽しみにしててね」と笑顔で答え返す。この瞬間を大切にするように彼女たちは言葉を交わし合う。</p>

        <p>窓から見える景色は時間と共に色褪せ始める。</p>
        <p>「お疲れ様でした」教室の最後に感謝の気持ちを伝える。「また来てくださいね」とクラスメートたちも笑顔で応じる。互いが心地よい空気と暖かな温度の中に包まれているかのように。</p>

        <p>帰り道、路地裏には夕暮れ時の薄暗さが始まりつつあった。</p>
        <p>「お母さん、明日はどうするの？」と拓也。「また新しいことを始めるんだよ」と小夜子は答え返す。その言葉に向けた微笑みを浮かべながら歩く二人。</p>

        <p>窓ガラスには闇が迫り始めた。</p>
        <p>「新しい日々が始まるわね」そう独りでつぶやき、リビングの光を見据える小夜子。「明日も頑張ろう」と心の中で強く決意する。この瞬間は静かに終わりを迎えつつあった。</p>
      </div>
    </section>
    <section class="chapter" id="chapter-3">
      <div class="chapter-header">
        <span class="chapter-number">第3章</span>
        <h2 class="chapter-title">家族の一日</h2>
      </div>
      
      <div class="chapter-body">
        <p>朝露が公園の芝生を濡らし、陽光にきらめいていた。爽やかな風が木々を通じてそよぎ、遠近から鳥たちのさえずりが聞こえる。公園にはすでに家族連れが多く訪れ、子供たちは滑り台や砂場で遊び声を響かせていた。</p>

        <p>小夜子はショートパンツ姿にノースリーブシャツという軽装束だった。その肌には風が心地よく触れるようだ。「今日も一日が始まるわね」と、夫の健太郎と二人で息子の拓也をベビーカーに乗せた。</p>

        <p>「ママはいつもきれいね」</p>
        <p>そう言って健太郎に微笑んだ小夜子だが、瞳には少しばかり疲労が見えた。新しい生活への順応は思った以上に大変だったからだ。「公園へ行こう」と拓也を抱き上げると、その小さな手が母親の顔へ伸びた。</p>

        <p>「ママ、ここ」</p>
        <p>拓也は小夜子の腕にある傷痕を見つめている。</p>
        <p>「あら、まだ痛むかしら？」と優しく尋ねる。「少ししかいないよ」と答えて笑いながらも、小夜子の手には力を込めて握り返された。</p>

        <p>公園に着くとすぐに拓也は砂場へ駆け込んだ。その小さな姿が遠ざかるにつれ、健太郎との距離感が近づいていく。</p>
        <p>「最近忙しそうだね」と静かな声で彼女は言った。「新しい地域での生活も慣れてきたかしら」</p>
        <p>「ああ…もう少しすれば大丈夫になるだろう。君の料理教室が始まったのも助かる」</p>

        <p>小夜子は夫に目を向け、その視線を感じた。「ありがとうございます」と小さく口元が動いた。</p>
        <p>「今日は一緒に過ごす時間が欲しかったから」と健太郎も笑顔で答えた。</p>

        <p>滑り台やブランコを制覇した拓也が母親の腕の中でうっとりと目を見開いている。その瞳には公園の景色全てが映し出されているようだ。「ママ、見て」彼女は息子から視線を受け取り、「どんな？」と静かに問い返す。</p>

        <p>「青い空」と答えた後で微笑んだ。</p>
        <p>小夜子は深呼吸して、木々や芝生の緑の香りを吸い込んだ。公園全体が絶妙なハーモニーを作っているように聞こえる。「ママも見てるよ」</p>

        <p>息子と過ごす時間が無性に心地よく感じられたからだ。</p>
        <p>「あら、小夜さん」</p>
        <p>突然、声がかかった。</p>

        <p>振り返ると元の地域からの友人、佐藤さんが立っていた。彼女は短い会話を交わした後、「またね」と微笑んで別れた。「新しい環境にも慣れてきたようね」</p>

        <p>その言葉を聞いて少し心地よさが増す。</p>
        <p>「小夜さん、君も友達が増えたの？」と健太郎に尋ねられる。彼女はうなずいた。</p>

        <p>拓也が砂場で掘り出していた土粒を母親の手に乗せると、「ママ、これきれい」と笑顔を見せた。「ありがとう」そう言って彼女の指先では小さな土塊が溶けていく。</p>
        <p>公園では子供たちの声と遊び心に満ちていても、小夜子はその中で家族との静かな時間を見つけることができていた。</p>
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>完璧ママの日々奮闘記</p>
    <p>Generated locally with Ollama + Stable Diffusion</p>
  </footer>


  <button class="tts-fab" id="ttsFab" onclick="ttsToggle()" title="Read aloud">
    <span id="ttsFabIcon">&#x1f50a;</span>
  </button>
  <div class="tts-bar" id="ttsBar">
    <button onclick="ttsPause()" id="ttsPauseBtn">&#x23f8;</button>
    <button onclick="ttsStop()">&#x23f9;</button>
    <button onclick="ttsPrev()">&#x23ee;</button>
    <button onclick="ttsNext()">&#x23ed;</button>
    <span class="tts-info" id="ttsInfo">Ready</span>
    <span class="tts-speed">
      <input type="range" id="ttsSpeed" min="0.5" max="2.0" step="0.1"
             value="1.0" onchange="ttsSetSpeed(this.value)" />
      <span id="ttsSpeedVal">1.0x</span>
    </span>
  </div>

  <button class="mode-toggle" onclick="toggleMode()">🌗 表示切替</button>

  <script>
    // Reading mode
    function toggleMode() {
      document.body.classList.toggle('light');
      localStorage.setItem('mode', document.body.classList.contains('light') ? 'light' : 'dark');
    }
    if (localStorage.getItem('mode') === 'light') document.body.classList.add('light');

    // Scroll progress
    window.addEventListener('scroll', () => {
      const h = document.documentElement;
      const pct = (h.scrollTop / (h.scrollHeight - h.clientHeight)) * 100;
      document.getElementById('progress').style.width = pct + '%';
    });

    // === TTS (Web Speech API) ===
    const synth = window.speechSynthesis;
    let ttsChs = [], ttsI = 0, ttsRate = 1.0, ttsOn = false, ttsPd = false;

    document.querySelectorAll('.chapter').forEach((sec, i) => {
      const b = sec.querySelector('.chapter-body');
      const t = sec.querySelector('.chapter-title');
      if (b) ttsChs.push({
        title: t ? t.textContent : ('Ch.' + (i+1)),
        text: b.textContent.trim(), el: sec
      });
    });

    function ttsToggle() {
      if (!synth) { alert('Speech not supported'); return; }
      if (ttsOn) { ttsStop(); return; }
      const sy = window.scrollY + window.innerHeight / 3;
      let cl = 0;
      ttsChs.forEach((c, i) => { if (c.el.offsetTop <= sy) cl = i; });
      ttsI = cl; ttsOn = true; ttsPd = false;
      document.getElementById('ttsFab').classList.add('speaking');
      document.getElementById('ttsFabIcon').innerHTML = '&#x23f9;';
      document.getElementById('ttsBar').classList.add('active');
      _ttsRead();
    }

    function _ttsRead() {
      if (ttsI >= ttsChs.length) { ttsStop(); return; }
      synth.cancel();
      const ch = ttsChs[ttsI];
      document.getElementById('ttsInfo').textContent = ch.title;
      ch.el.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Split by Japanese sentence endings for reliable playback
      const sents = ch.text.match(/[^。！？
]+[。！？]?/g) || [ch.text];
      let si = 0;

      function next() {
        if (!ttsOn) return;
        if (si >= sents.length) {
          ttsI++;
          if (ttsI < ttsChs.length) setTimeout(_ttsRead, 800);
          else ttsStop();
          return;
        }
        const u = new SpeechSynthesisUtterance(sents[si].trim());
        u.lang = 'ja-JP'; u.rate = ttsRate;
        const vs = synth.getVoices();
        const jv = vs.find(v => v.lang && v.lang.startsWith('ja'));
        if (jv) u.voice = jv;
        u.onend = () => { si++; next(); };
        u.onerror = () => { si++; next(); };
        synth.speak(u);
      }
      next();
    }

    function ttsPause() {
      if (!ttsOn) return;
      if (ttsPd) {
        synth.resume(); ttsPd = false;
        document.getElementById('ttsPauseBtn').innerHTML = '&#x23f8;';
      } else {
        synth.pause(); ttsPd = true;
        document.getElementById('ttsPauseBtn').innerHTML = '&#x25b6;';
      }
    }

    function ttsStop() {
      synth.cancel(); ttsOn = false; ttsPd = false;
      document.getElementById('ttsFab').classList.remove('speaking');
      document.getElementById('ttsFabIcon').innerHTML = '&#x1f50a;';
      document.getElementById('ttsBar').classList.remove('active');
      document.getElementById('ttsInfo').textContent = 'Ready';
      document.getElementById('ttsPauseBtn').innerHTML = '&#x23f8;';
    }

    function ttsNext() { if (ttsOn && ttsI < ttsChs.length - 1) { ttsI++; _ttsRead(); } }
    function ttsPrev() { if (ttsOn && ttsI > 0) { ttsI--; _ttsRead(); } }
    function ttsSetSpeed(v) {
      ttsRate = parseFloat(v);
      document.getElementById('ttsSpeedVal').textContent = v + 'x';
    }
    if (synth) synth.onvoiceschanged = () => synth.getVoices();

  </script>
</body>
</html>